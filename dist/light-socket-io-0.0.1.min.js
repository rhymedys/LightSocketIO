/*
 * LIGHT-SOCKET-IO v0.0.1
 * (c) 2016-2018 Rhymedys<Rhymedys@gmail.com>
 * Released under the MIT license.
 */
!function(t,e){"object"==typeof exports&&"undefined"!=typeof module?module.exports=e():"function"==typeof define&&define.amd?define(e):t.LightSocketIO=e()}(this,function(){"use strict";function t(e,n,o){if(null==e)return"";var i="",r=typeof e;if("string"===r||"number"===r||"boolean"===r)i+="&"+n+"="+(null==o||o?encodeURIComponent(e):e);else for(var a in e){var c=null==n?a:n+(e instanceof Array?"["+a+"]":"."+a);i+=t(e[a],c,o)}return i}var e=function(t,e){this.logTag="LightSocket",this.socketClient=null,this.eventType=null,this.socketReadyState=null,this.heartBreakInterval=null,this.heartBreakCallbackInterval=null,this.reconnectSocketClientTimeOut=null,this.callbackList={onopen:null,onmessage:null,onclose:null,onbeforeunload:null,onerror:null},this.socketClientRunning=!1,this.lockReconnectSocketClient=!1,this.options=e,this.nextAutoConnectTimeOut=0,this.msgsCache=[],this.callbackMap={onopen:new Map,onmessage:new Map,onclose:new Map,onbeforeunload:new Map,onerror:new Map},this.socketApi=this.reclaimApiProtocol(t),this.setEventType(),this.setSocketReadyState(),this.checkAndInitSocketUtils(t)};return e.prototype.reclaimApiProtocol=function(t){var e="ws://"+t;return window.location.protocol.match("https:")&&(e=e.replace("ws","wss")),e},e.prototype.checkAndInitSocketUtils=function(t){t||this.throwError("socketApi can not be null"),this.checkBrowserSupportWebSocket()||this.throwError("this browser unsupport websocket"),this.createSocket(t)},e.prototype.checkBrowserSupportWebSocket=function(){return"WebSocket"in window},e.prototype.setEventType=function(){this.eventType={onopen:"onopen",onmessage:"onmessage",onclose:"onclose",onbeforeunload:"onbeforeunload",onerror:"onerror"}},e.prototype.setSocketReadyState=function(){this.socketReadyState={CLOSED:3,CLOSING:2,OPEN:1,CONNECTING:0}},e.prototype.getSocketValue=function(t){return{0:"CONNECTING",1:"OPEN",2:"CLOSING",3:"CLOSED"}[t]},e.prototype.clearHeartBreakInterval=function(){this.heartBreakInterval&&window.clearInterval(this.heartBreakInterval)},e.prototype.clearHeartBreakCallbackInterval=function(){this.heartBreakCallbackInterval&&window.clearInterval(this.heartBreakCallbackInterval)},e.prototype.openHeatBreak=function(t,e){void 0===t&&(t=30),void 0===e&&(e="ping");var n=this,o=e;this.clearHeartBreakInterval(),e instanceof Object&&(o=JSON.stringify(e)),"string"==typeof o?this.heartBreakInterval=window.setInterval(function(){n.callGobalErrorCallback("\u53d1\u9001\u5fc3\u8df3\u5305\uff0c\u5185\u5bb9\u4e3a:"+o),n.sendMsg(o)},1e3*t):this.throwError("\u5fc3\u8df3\u5305content\u7c7b\u578b\u4e0d\u80fd\u4e3a\u975eObject\u6216String\u7c7b\u578b")},e.prototype.openHeartBreakCallbackTimer=function(){if(this.options.heartPackageConfig&&this.options.heartPackageConfig.openHeatBreakCallbackTimer){var t=this.options.heartPackageConfig.heatBreakCallbackDuration||30;this.heartBreakCallbackInterval=window.setInterval(function(){},1e3*t)}},e.prototype.callCallbackMap=function(t){for(var e=[],n=arguments.length-1;n-- >0;)e[n]=arguments[n+1];t&&this.callbackMap[t]&&this.callbackMap[t].length>0&&this.callbackMap[t].forEach(function(t){return t&&t instanceof Function&&t.apply(void 0,e)})},e.prototype.onOpenCallback=function(t){var e=this;t.currentTarget.readyState===this.socketReadyState.OPEN&&(this.socketClientRunning=!0,this.nextAutoConnectTimeOut=0,this.options&&this.options.heartPackageConfig&&this.options.heartPackageConfig.open&&this.openHeatBreak(this.options.heartPackageConfig.interval,this.options.heartPackageConfig.content)),this.callbackList.onopen&&this.callbackList.onopen(t.currentTarget),this.callbackMap(this.eventType.onopen,t.currentTarget),this.socketClient.onmessage=function(t){return e.callbackList.onmessage(t.data,t)}},e.prototype.onCloseCallback=function(t){this.socketClientRunning=!1,this.clearHeartBreakInterval(),this.callbackList.onclose&&this.callbackList.onclose(t.currentTarget),this.callbackMap(this.eventType.onclose,t.currentTarget),this.options&&this.options.autoReconnect&&this.reconnectSocketClient()},e.prototype.onBeforeUnloadCallback=function(t){this.callbackList.onbeforeunload&&this.callbackList.onbeforeunload(t.currentTarget),this.callbackMap(this.eventType.onbeforeunload,t.currentTarget)},e.prototype.onErrorCallback=function(t){this.socketClientRunning=!1,this.clearHeartBreakInterval(),this.callbackList.onerror&&this.callbackList.onerror(t.currentTarget),this.callbackMap(this.eventType.onerror,t.currentTarget),this.options&&this.options.autoReconnect&&this.reconnectSocketClient()},e.prototype.callGobalErrorCallback=function(t){this.options&&this.options.goablErrorCallback&&this.options.goablErrorCallback(t)},e.prototype.registerCallbackListener=function(t){if(this.socketClient)switch(t){case this.eventType.onopen:this.socketClient.onopen=this.onOpenCallback;break;case this.eventType.onclose:this.socketClient.onclose=this.onCloseCallback;break;case this.eventType.onbeforeunload:this.socketClient.onbeforeunload=this.onBeforeUnloadCallback;break;case this.eventType.onerror:this.socketClient.onerror=this.onErrorCallback;break;default:this.socketClient.onerror=this.onErrorCallback,this.socketClient.onbeforeunload=this.onBeforeUnloadCallback,this.socketClient.onclose=this.onCloseCallback,this.socketClient.onopen=this.onOpenCallback}},e.prototype.on=function(t,e){return t&&e instanceof Function?this.eventType[t(this.eventType)]&&e&&(this.callbackList[t(this.eventType)]=e,this.registerCallbackListener(t(this.eventType))):this.throwError("eventTypeCallback should be a function"),this},e.prototype.addCallback=function(t,e,n){return t&&e&&n instanceof Function?this.eventType[t(this.eventType)]&&n&&(this.callbackMap[t(this.eventType)].set(e,n),this.registerCallbackListener(t(this.eventType))):this.throwError("eventTypeCallback should be a function or eventKey should not be null"),this},e.prototype.removeCallback=function(t,e){return t&&e?this.eventType[t(this.eventType)]&&(this.callbackMap[t(this.eventType)].delete(e),this.registerCallbackListener(t(this.eventType))):this.throwError("eventTypeCallback should be a function or eventKey should not be null"),this},e.prototype.sendMsg=function(t,e){return this.socketClientRunning&&this.socketClient?this.socketClient.send(t):(this.reconnectSocketClient(),e&&e(t)),this},e.prototype.getState=function(){return this.socketClientRunning},e.prototype.createSocket=function(e){if(e&&this.checkBrowserSupportWebSocket()){var n;this.options&&this.options.query&&(n=t(this.options.query),0===n.indexOf("&")&&(n=n.substring(1,n.length))),this.socketClient?(this.socketClient.close(),this.callGobalErrorCallback("\u91cd\u8fdeSocketClient")):this.callGobalErrorCallback("\u521b\u5efa\u4e14\u8fde\u63a5SocketClient");try{this.socketClient=new WebSocket(e+"?"+n),this.registerCallbackListener()}catch(t){this.reconnectSocketClient()}}return this},e.prototype.reconnectSocketClient=function(){var t=this;this.lockReconnectSocketClient||(this.lockReconnectSocketClient=!0,this.reconnectSocketClientTimeOut&&(window.clearTimeout(this.reconnectSocketClientTimeOut),this.reconnectSocketClientTimeOut=null),this.reconnectSocketClientTimeOut=window.setTimeout(function(){t.createSocket(t.socketApi),t.nextAutoConnectTimeOut+=1e4,t.callGobalErrorCallback("\u6b63\u5728\u91cd\u8fde \u4e0b\u6b21\u91cd\u8fde\u65f6\u95f4\u95f4\u9694 "+t.nextAutoConnectTimeOut/1e3+"s"),t.lockReconnectSocketClient=!1},t.nextAutoConnectTimeOut))},e.prototype.closeSocket=function(){this.socketClientRunning&&this.socketClient&&this.socketClient.close()},e.prototype.throwError=function(t){throw new Error(t)},e});